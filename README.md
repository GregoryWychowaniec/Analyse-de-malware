# TP Malware
## TP0 : Introduction aux sources ouvertes
* Contexte : un utilisateur nous informe d'un fichier infecté : "0a117b9eaf9d8e6225ca4f2ecc4827e0"
  * [VirusTotal](https://www.virustotal.com/#/home/upload)
  * [ThreadCrowd](https://www.threatcrowd.org/domain.php?domain=lucky.manlish.net)
    * Regarder le Whois : uk_vietnam@yahoo.com
* Envoyer à tp@kwiatkowski.fr

## TP1 : Un comportement inexplicable
* Configuration
  * Importer la machine infectée malware1.ova située dans /VM/ dans VirtualBox
  * Configurer Hiren's Boot CD en tant que contrôleur IDE dans Configuration/Stockage de la VM
  * Regarder ce qui est démarré au lancement de la machine avec msconfig.exe puis avec autoruns.exe (si besoin)
  * Ajouter un dossier partagé permanent dans la configuration de la VM puis la redémarrer
* Analyse
  * Ouvrir le fichier funny_videos.txt : c'est un script batch
  * Tuer le processus
  * Nettoyer les clés de registre
  * Supprimer funny_videos.exe
  * La machine est décontaminée
* Morale
  * Brancher une clé USB sur une machine infectée, c'est mal
  * Ne pas afficher les extensions, c'est mal
  
## TP2 : Volatility
* Contexte : On a un dump mémoire
* Volatility
  * Lister les processus actifs
    * vol.py -f [File.raw] imageinfo : renvoie des infos dont une liste de profils
    * vol.py -f [File.raw] --profile [profil] pslist
  * Récupérer les processus lancés au démarrage
    * vol.py -f [File.raw] --profile [profil] printkey -K "Software\Microsoft\Windows\CurrentVersion\Run"
    * On voit un fichier dans un dossier Temp lancé au démarrage : méthode habituelle de malwares
    * On repère le PID 3444 correspondant au fichier dans Temp
    * mkdir dump
    * vol.py -f [File.raw] --profile [premier profil] procdump -D dump/ -p [PID du processus correspondant au fichier dans Temp]
  * Chercher des informations
    * Upload sur VirusTotal
    * Issu d'une campagne de malwares japonaise (Tokyo) de 2014
    * vol.py -f [File.raw] --profile [premier profil] connscan : indique que le malware se connecte à 58.158.177.102 en HTTP
    
## TP4 : Analyse statique
* Installer les guest additions sur Windows XP
  * Configuration / Dossiers partagés
    * Ajouter un dossier en cochant toutes les cases
  * Dans la machine, périphériques / insérer l'image CD des additions invité
  * Vérifier que Hiren's Boot CD est maître primaire et que les guest additions sont esclave primaire
* DependencyWalker
  * Donne les imports, pas les ressources
* [Manalyzer](https://manalyzer.org/)
  * Fait un appel à VirusTotal
  * static-analysis_1.mal
    * Timestamp dans le futur : clairement truqué
    * Contient une resource : ce malware est un dropper
      * Cette ressource a des chances de télécharger un fichier et de le mettre dans un fichier temporaire
      * Possiblement un installeur : il n'y a pas la backdoor
        * Si l'installation réussit, la backdoor est installée
        * Si l'installation foire, les défenseurs n'ont pas la backdoor
      * Si la backdoor tombe quand même dans les mains du défenseur
        * Il y a toujours des moyens de ne pas se faire avoir en n'envoyant pas le malware, mais un fichier bidon
  * static-analysis_2.mal
    * Timestamp plausible
    * Sections
      * Entropy
        * Entropie élevée => chiffré ou binaire
      * UPX0, UPX1 et UPX2 sont des fichiers clean selon VirusTotal
    * L'analyse statique ne renvoie pas grand chose sur ce fichier packé
* PracticalMalwareAnalysis.com
  * site d'netraînement pour Windows XP, comme webgoat ou rootme pour le pentest
  
## TP5 : Analyses dynamique
Sandboxie et Buster Sandbox Analyzer
[Lien 1](https://cuckoo.cert.ee/)

## TP6 : Analyse manuelle
Assembleur

## TP7 : Analyse manuelle
**Avec IDA**
* View > Open subviews > Strings
* Double cliquer sur la chaîne de caractères qui nous intéresse
  * Un onglet IDA View-B doit s'ouvrir, sinon fermer l'onglet qui s'est ouvert
* Repérer dans IDA View-B
* Clic droit dans la deuxième colonne de la ligne qui nous intéresse
    * Jump to xref to operand (on aurait pu appuyer sur x)
    * Ok (une seule référence dans ce TP)
* On obtient dans l'onglet un graphe où est appelé la chaîne de caractères
    * String2
      * Chaîne de caractère qui nous intéresse
      * On push dedans 3 groupes d'octets
        * les octets sont pushés comme dans une pile => on décode d'hexa en ascii sans oublier de faire le miroir sur les groupes d'octets

**Avec OllyDbg**
* Vue principale
  * En bas à droite la pile
  * En haut à droite les registres
  * Tout en bas à droite, l'état de l'exécutable
* F7, F8, F9 : avancer dans le programme à notre rythme
  * F7 : Avancer d'une instruction, descend dans une fonction
  * F8 : Avancer d'une instruction, ne descend pas dans le code d'une fonction
    * Utile pour éviter le code tierce
  * F9 : Exécuter jusqu'à un breakpoint
* Remplacer un JNZ par un NOP après un test de vérification => bypass de vérification
  * Attention à ne pas tout crasher
  * Repérer l'adresse de l'appel à la fonction de vérification dans IDA (plus facile)
  * Aller à cette adresse dans OllyDbg, et remplacer le JNZ juste après le call par un NOP


